# BRAVOCARS - Configuration & Conventions

**CRITICAL: READ THIS BEFORE MAKING ANY CHANGES**

This document defines the working configuration and conventions. DO NOT change these without updating this document and testing thoroughly.

## JSON Serialization Convention

### ⚠️ CRITICAL: Backend uses camelCase JSON
- **Backend**: Configured to use `camelCase` for JSON serialization
- **Frontend**: Expects `camelCase` from API responses
- **Location**: `Backend/CarAuction.API/Program.cs:208-213`

```csharp
// DO NOT REMOVE OR MODIFY THIS
builder.Services.AddControllers()
    .AddJsonOptions(options =>
    {
        options.JsonSerializerOptions.PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase;
    });
```

**Examples of correct casing:**
- ✅ `roles` (not `Roles`)
- ✅ `firstName` (not `FirstName`)
- ✅ `isApproved` (not `IsApproved`)

### Why This Matters
- Frontend TypeScript models generated by Orval use camelCase
- Backend C# DTOs use PascalCase
- ASP.NET Core automatically converts PascalCase → camelCase at runtime
- Breaking this breaks ALL API responses

## API Configuration

### Base URLs and Routing

**Backend:**
- Port: `5142`
- Base URL: `http://localhost:5142`
- API Routes: `/api/[Controller]/[Action]`

**Frontend:**
- Port: `5173`
- Base URL: `http://localhost:5173`
- Proxy: Vite proxies `/api/*` to backend

**axios-instance.ts Configuration:**
```typescript
// DO NOT ADD baseURL - Orval generates full paths
const axiosInstance = axios.create({
  // No baseURL property here
});
```

**Why:** Orval generates URLs with `/api/` prefix already included. Adding `baseURL: '/api'` causes duplication (`/api/api/...`)

## CORS Configuration

**Location:** `Backend/CarAuction.API/Program.cs:215-229`

**Allowed Origins:**
- `http://localhost:5173` (Vite dev server)
- `http://localhost:5174` (Alternative port)

**DO NOT REMOVE THESE ORIGINS** or frontend will get CORS errors.

## Authentication & Authorization

### Admin Login Credentials
- Email: `admin@bravocars.com`
- Password: `Admin@123456`
- Roles: `["Admin", "User"]`
- IsApproved: `true`

### Role Checking Convention
```javascript
// ✅ CORRECT - camelCase
const isAdmin = user?.roles?.includes('Admin');

// ❌ WRONG - PascalCase (backend no longer sends this)
const isAdmin = user?.Roles?.includes('Admin');
```

### JWT Configuration
- Token stored in: `localStorage.getItem('accessToken')`
- Refresh token: `localStorage.getItem('refreshToken')`
- User data: `localStorage.getItem('user')`

## Code Generation (Orval)

### Configuration File
**Location:** `Frontend/orval.config.ts`

**Generated Files Location:** `Frontend/src/api/generated/`

### When to Regenerate
Run `npm run generate:api` when:
1. Backend DTO properties change
2. Backend endpoints added/removed/modified
3. After changing return types in controllers

**Command:**
```bash
cd Frontend
npm run generate:api
```

### Important Rules
1. **Never manually edit generated files** - they get overwritten
2. **Always use generated types** - don't create duplicate interfaces
3. **Check generated types** after regeneration to ensure correctness

## Email Service

### Current State
- SMTP not configured for development
- Email failures are caught and logged as warnings
- **DO NOT** let email failures break registration/operations

**Location:** `Backend/CarAuction.Infrastructure/Services/Auth/AuthService.cs:65-73`

```csharp
// Email failures must not break registration
try
{
    await _emailService.SendRegistrationEmailAsync(user.Email!, user.FirstName);
}
catch (Exception emailEx)
{
    _logger.LogWarning(emailEx, "Failed to send registration email...");
    // Continue execution - email failure is non-critical in dev
}
```

## Database

### Connection String
- Database: `bravocars`
- Host: `localhost:5432`
- User: `postgres`
- Password: `postgres`

### Seeded Data
- Admin user exists (see Auth section)
- 4 sample users (`user1@example.com`, `user2@example.com`, `bidder1@example.com`, `bidder2@example.com`)
- 6 sample cars
- 6 sample auctions

**Password for all sample users:** `User@123456`

## Testing Checklist Before Deploying Changes

Before committing any changes, test:

1. **Registration Flow**
   - [ ] New user can register
   - [ ] Success message shows
   - [ ] Redirect to login works
   - [ ] Email failure doesn't break flow

2. **Login Flow**
   - [ ] Admin can login: `admin@bravocars.com` / `Admin@123456`
   - [ ] Regular user can login (if approved)
   - [ ] Token stored in localStorage
   - [ ] Redirect to home page works

3. **Authorization**
   - [ ] Admin can access `/admin/*` routes
   - [ ] Non-admin redirected from admin pages
   - [ ] Unauthenticated users redirected to login

4. **API Communication**
   - [ ] No `/api/api/` URL duplication
   - [ ] No CORS errors in console
   - [ ] Responses in camelCase format
   - [ ] TypeScript types match responses

## Common Issues & Solutions

### Issue: "Cannot access admin pages"
**Cause:** Role checking uses wrong casing
**Solution:** Use `user?.roles` (camelCase) not `user?.Roles`

### Issue: "Navbar doesn't update after login (need to refresh)"
**Cause:** Zustand store had `isAuthenticated` as a getter (non-reactive)
**Solution:** Derive `isAuthenticated` from `user` state in components: `const isAuthenticated = !!user`
**Note:** Never use getters in Zustand - they don't trigger re-renders

### Issue: "404 on /api/api/..."
**Cause:** axios baseURL conflicts with Orval
**Solution:** Remove `baseURL` from axios-instance.ts

### Issue: "CORS error"
**Cause:** Frontend origin not in CORS allowlist
**Solution:** Add origin to `Program.cs` CORS configuration

### Issue: "Registration returns 400 but user created"
**Cause:** Email service throwing unhandled exception
**Solution:** Wrap email calls in try-catch (already fixed)

### Issue: "TypeScript types don't match API response"
**Cause:** Orval types out of sync with backend
**Solution:** Run `npm run generate:api`

### Issue: "Port already in use"
**Cause:** Previous backend instance still running
**Solution:** `pkill -9 dotnet` or `lsof -ti:5142 | xargs kill -9`

## File Modification Safety Rules

### Before Modifying These Files - STOP AND THINK:

1. **`Program.cs`** - Core app configuration
   - JSON serialization settings
   - CORS configuration
   - Authentication/Authorization

2. **`axios-instance.ts`** - API communication
   - No baseURL property
   - Auth interceptors only

3. **`AuthController.cs`** - Authentication endpoints
   - Return type must be `ActionResult<ApiResponse<T>>`
   - Never return `IActionResult` (breaks Swagger)

4. **`orval.config.ts`** - API generation
   - Changes affect all generated code

5. **`AdminRoute.jsx`** - Authorization guard
   - Uses `user?.roles` (camelCase)

### Safe to Modify:
- Page components (add new features)
- Service implementations (keep interfaces same)
- Styles and UI components
- New DTOs (then regenerate with Orval)

## Version Information

- .NET: 9.0
- Node: Latest LTS
- React: 19.1.1
- Vite: 7.1.7
- Ant Design: 5.x (⚠️ React 19 compatibility warning - non-critical)
- PostgreSQL: Latest
- Redis: Latest

### Known Warnings (Non-Critical)

1. **Ant Design React 19 Warning:**
   ```
   Warning: [antd: compatible] antd v5 support React is 16 ~ 18
   ```
   - **Status:** Non-critical - all features work correctly
   - **Cause:** React 19 was released after Ant Design v5
   - **Impact:** None - just a console warning
   - **Solution:** Wait for Ant Design v6 or React 19 compatibility update
   - **Reference:** https://u.ant.design/v5-for-19

## Last Updated
2025-11-02

## Notes
- This is a development configuration
- Production will need different CORS, connection strings, etc.
- Keep this document updated when making configuration changes
